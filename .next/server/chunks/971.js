"use strict";exports.id=971,exports.ids=[971],exports.modules={10854:(t,e,a)=>{a.d(e,{A:()=>r});var r=function(t){return t.STANDARD="STANDARD",t.DNB="DNB",t.NAMHAE="NAMHAE",t}({})},18971:(t,e,a)=>{a.d(e,{op:()=>u,qT:()=>m,ws:()=>p});var r=a(17464);a(55414);var o=a(13913),i=a(8613),n=a(26763),s=a(70954),c=a(10854),l=a(73103),d=a(98149);async function m(t,e){try{let a=(0,n.Ak)(),r=(0,n.Ak)();try{await o.db.insert(i.contracts).values({id:a,contractNumber:t.contractNumber,contractDate:t.contractDate,exporter:t.exporter,importerId:t.importer,incoterms:t.incoterms}).returning()}catch(t){throw console.error("계약 정보 저장 중 오류:",t),Error(`계약 정보 저장 실패: ${t instanceof Error?t.message:"알 수 없는 오류"}`)}try{let e=(0,n.Ak)();await o.db.insert(i.payments).values({id:e,paymentDueDate:t.contractDate,paymentMethod:"T/T",contractId:a}).returning(),await o.db.insert(i.paymentsTt).values({paymentId:e,advancePaymentDate:t.contractDate,advancePaymentRatio:30,remainingPaymentDate:t.contractDate,remainingPaymentRatio:70,counterpartBank:""}).returning()}catch(t){throw console.error("결제 정보 저장 중 오류:",t),Error(`결제 정보 저장 실패: ${t instanceof Error?t.message:"알 수 없는 오류"}`)}try{await o.db.insert(i.shipments).values({id:r,contractId:a,estimatedTimeArrival:t.estimatedTimeArrival,estimatedTimeDeparture:t.estimatedTimeDeparture,arrivalPort:t.arrivalPort,departurePort:t.departurePort}).returning()}catch(t){throw console.error("선적 정보 저장 중 오류:",t),Error(`선적 정보 저장 실패: ${t instanceof Error?t.message:"알 수 없는 오류"}`)}for(let t of e)try{let e;let a=(0,n.Ak)(),s=await o.db.query.items.findFirst({where:(e,{eq:a,and:r})=>r(a(e.itemName,t.itemName),t.itemVariety?a(e.itemVariety,t.itemVariety):void 0,t.hsCode?a(e.hsCode,t.hsCode):void 0,a(e.packingUnit,t.packingUnit))});if(s)e=s.id;else{let[a]=await o.db.insert(i.items).values({id:(0,n.Ak)(),itemName:t.itemName,itemVariety:t.itemVariety,originCountry:null,hsCode:t.hsCode,packingUnit:t.packingUnit}).returning();e=a.id}let c=(0,n.Ak)();await o.db.insert(i.cargos).values({id:c,itemsId:e,shipmentId:r,containerCount:1,contractTon:t.contractTon,progressStatus:"REVIEW",purchaseFeeRate:t.purchaseFeeRate,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}).returning(),await o.db.insert(i.costs).values({id:a,cargoId:c,supplyPrice:t.unitPrice,laborCost:0,transportStorageFee:0,loadingUnloadingFee:0}).returning(),await o.db.insert(i.costDetails).values({id:(0,n.Ak)(),costId:a,unitPrice:t.unitPrice,exchangeRate:t.exchangeRate,customsTaxRate:t.customsTaxRate,customsFee:0,inspectionFee:0,doCharge:0,otherCosts:0,transferFee:0}).returning()}catch(t){throw console.error("화물 정보 저장 중 오류:",t),Error(`화물 정보 저장 실패: ${t instanceof Error?t.message:"알 수 없는 오류"}`)}return{success:!0,message:"계획이 성공적으로 저장되었습니다."}}catch(t){return console.error("계획 저장 중 오류 발생:",t),t instanceof Error&&console.error("오류 상세:",{message:t.message,stack:t.stack,name:t.name}),{success:!1,message:`계획 저장 중 오류가 발생했습니다: ${t instanceof Error?t.message:"알 수 없는 오류"}`}}}async function u(){return(await o.db.query.cargos.findMany({with:{item:!0,shipment:{with:{contract:{with:{importer:!0,payments:{with:{paymentsTt:!0}}}}}},costs:{with:{costDetails:!0}}},orderBy:(t,{desc:e})=>[e(t.createdAt)]})).map(t=>{let e=t.item,a=t.shipment,r=a?.contract,o=r?.importer,i=r?.payments?.[0],n=i?.paymentsTt,d=t.costs?.[0],m=d?.costDetails?.[0],u={contract:{id:r?.id||"",contractNumber:r?.contractNumber||"",contractDate:r?.contractDate||"",exporter:r?.exporter||"",importerId:r?.importerId||"",incoterms:r?.incoterms||"",createdAt:r?.createdAt||"",updatedAt:r?.updatedAt||""},shipment:{id:a?.id||"",contractId:r?.id||"",estimatedTimeDeparture:a?.estimatedTimeDeparture||"",estimatedTimeArrival:a?.estimatedTimeArrival||"",shippingCompany:a?.shippingCompany||"",departurePort:a?.departurePort||"",arrivalPort:a?.arrivalPort||"",blNumber:a?.blNumber||"",palletOrderDate:a?.palletOrderDate||"",palletType:a?.palletType||"",createdAt:a?.createdAt||"",updatedAt:a?.updatedAt||""},cargo:{id:t?.id||"",remark:t?.remark||"",itemsId:t?.itemsId||"",shipmentId:a?.id||"",containerCount:t?.containerCount||0,contractTon:t?.contractTon||0,progressStatus:t?.progressStatus||"예정",customsClearanceDate:t?.customsClearanceDate||"",quarantineDate:t?.quarantineDate||"",warehouseEntryDate:t?.warehouseEntryDate||"",sellingPrice:t?.sellingPrice||0,margin:t?.margin||0,totalProfit:t?.totalProfit||0,purchaseFeeRate:t?.purchaseFeeRate||0,sellingPriceWholesale:t?.sellingPriceWholesale||0,sellingPriceRetail:t?.sellingPriceRetail||0,createdAt:t?.createdAt||"",updatedAt:t?.updatedAt||""},cost:{id:d?.id||"",cargoId:t?.id||"",supplyPrice:d?.supplyPrice||0,shippingCost:d?.shippingCost||0,laborCost:d?.laborCost||0,transportStorageFee:d?.transportStorageFee||0,loadingUnloadingFee:d?.loadingUnloadingFee||0,usanceInterest:d?.usanceInterest||0},costDetail:{id:m?.id||"",costId:d?.id||"",unitPrice:m?.unitPrice||0,exchangeRate:m?.exchangeRate||0,customsTaxRate:m?.customsTaxRate||0,customsFee:m?.customsFee||0,inspectionFee:m?.inspectionFee||0,doCharge:m?.doCharge||0,otherCosts:m?.otherCosts||0,transferFee:m?.transferFee||0},payment:{id:i?.id||"",contractId:r?.id||"",paymentMethod:i?.paymentMethod||"",paymentDueDate:i?.paymentDueDate||"",advancePaymentDate:n?.advancePaymentDate||"",advancePaymentRatio:n?.advancePaymentRatio||0,remainingPaymentDate:n?.remainingPaymentDate||"",remainingPaymentRatio:n?.remainingPaymentRatio||0,counterpartBank:n?.counterpartBank||"",paymentTerm:""},item:{id:e?.id||"",itemName:e?.itemName||"",itemVariety:e?.itemVariety||"",packingUnit:e?.packingUnit||"",originCountry:e?.originCountry||"",hsCode:e?.hsCode||""},importer:{id:o?.id||"",importerName:o?.importerName||"",calculationType:o?.calculationType||c.A.STANDARD}},p=(0,s.s)(u);return{id:t?.id||"",contractNumber:r?.contractNumber||"",progressStatus:l.LE[t?.progressStatus]||"예정",contractDate:r?.contractDate||"",importer:o?.importerName||"",exporter:r?.exporter||"",estimatedTimeArrival:a?.estimatedTimeArrival||"",arrivalPort:a?.arrivalPort||"",itemName:e?.itemName||"",contractTon:t?.contractTon||0,unitPrice:p.costDetail.unitPrice||0,totalPrice:p.costDetail.totalContractPrice||0,paymentMethod:i?.paymentMethod||"",warehouseEntryDate:t?.warehouseEntryDate||"",importCostPerKg:p.costDetail.costPerKg||0,supplyCostPerKg:p.cost.supplyPrice||0,totalCost:p.cargo.totalCost||0,totalCostPerKg:p.cargo.totalCostPerKg||0,sellingPrice:p.cargo.sellingPrice||0,margin:p.cargo.margin||0,totalProfit:p.cargo.totalProfit||0}})}async function p(t){try{await o.db.delete(i.cargos).where((0,d.RV)(i.cargos.id,t))}catch(t){throw console.error("Failed to delete plans:",t),Error("계획 삭제 중 오류가 발생했습니다.")}}(0,a(1634).D)([m,u,p]),(0,r.A)(m,"606d9cda8a7251d423c867e68bd2712076dd3d75b5",null),(0,r.A)(u,"00c98c97faae77e41f0007f4da888035fa98e3bd96",null),(0,r.A)(p,"4014f8936396d6646e3a51928c12b6bfe6f86e45fb",null)},70954:(t,e,a)=>{a.d(e,{s:()=>l});var r=a(10854);class o{calculate(t,e){let a=t.contractorCost*(1+e.purchaseFeeRate/100),r=(a-t.contractorCost)*e.contractTon*1e3,o=a*e.contractTon*1e3+e.shippingCost+e.laborCost+e.transportStorageFee+e.loadingUnloadingFee,i=e.sellingPrice-o/e.contractTon/1e3,n=i*e.contractTon*1e3,s=o/e.contractTon/1e3;return{supplyPrice:a,contractorProfit:r,totalCost:o,margin:i,totalProfit:n,totalCostPerKg:s}}}class i{calculate(t,e){let a=(t.contractorCostAmount+e.shippingCost+e.laborCost+e.transportStorageFee+e.loadingUnloadingFee+e.usanceInterest)/e.contractTon/1e3*(1+e.purchaseFeeRate/100),r=(a-t.contractorCost)*e.contractTon*1e3,o=a*e.contractTon*1e3,i=e.sellingPrice-o/e.contractTon/1e3,n=i*e.contractTon*1e3,s=o/e.contractTon/1e3;return{supplyPrice:a,contractorProfit:r,totalCost:o,margin:i,totalProfit:n,totalCostPerKg:s}}}class n{calculate(t,e){let a=t.contractorCost*(1+e.purchaseFeeRate/100),r=(a-t.contractorCost)*e.contractTon*1e3,o=a*e.contractTon*1e3+e.shippingCost+e.laborCost+e.transportStorageFee+e.loadingUnloadingFee,i=e.sellingPrice-o/e.contractTon/1e3,n=i*e.contractTon*1e3,s=o/e.contractTon/1e3;return{supplyPrice:a,contractorProfit:r,totalCost:o,margin:i,totalProfit:n,totalCostPerKg:s}}}class s{static createStrategy(t){if(!t)return new o;switch(t.calculationType){case r.A.STANDARD:return new o;case r.A.DNB:return new i;case r.A.NAMHAE:return new n;default:return new o}}}class c{constructor(t){this.data=t,this.calculationStrategy=s.createStrategy(t.importer),this.calculatedValues=this.calculateValues()}calculateValues(){let t=this.data.costDetail.unitPrice||0,e=this.data.costDetail.exchangeRate||0,a=this.data.cargo.contractTon||0,r=this.data.cargo.sellingPrice||0,o=this.data.cargo.purchaseFeeRate||0,i=Math.floor(t*e*a),n=t*e/1e3,s=i*(this.data.costDetail.customsTaxRate||0)/100,c=i+s+(this.data.costDetail.transferFee||0)+(this.data.costDetail.customsFee||0)+(this.data.costDetail.inspectionFee||0)+(this.data.costDetail.doCharge||0)+(this.data.costDetail.otherCosts||0),l=c/a/1e3,d=i*(this.data.payment.advancePaymentRatio||0)/100,m=i*(this.data.payment.remainingPaymentRatio||0)/100,u=this.calculationStrategy.calculate({contractorCostAmount:c,costPerKg:n,totalContractPrice:i,contractorCost:l},{contractTon:a,sellingPrice:r,purchaseFeeRate:o,shippingCost:this.data.cost.shippingCost||0,laborCost:this.data.cost.laborCost||0,transportStorageFee:this.data.cost.transportStorageFee||0,loadingUnloadingFee:this.data.cost.loadingUnloadingFee||0,usanceInterest:this.data.cost.usanceInterest||0});return{supplyPrice:u.supplyPrice,margin:u.margin,totalProfit:u.totalProfit,totalContractPrice:i,costPerKg:n,contractorCost:l,contractorProfit:u.contractorProfit,totalCost:u.totalCost,totalCostPerKg:u.totalCostPerKg,customTaxAmount:s,advancePaymentAmount:d,remainingPaymentAmount:m}}mapItem(t){return{id:t.id,itemName:t.itemName||"",itemVariety:t.itemVariety||"",originCountry:t.originCountry||"",hsCode:t.hsCode||"",packingUnit:t.packingUnit||""}}mapShipment(t){return{id:t.id,estimatedTimeArrival:t.estimatedTimeArrival||"",estimatedTimeDeparture:t.estimatedTimeDeparture||"",arrivalPort:t.arrivalPort||"",departurePort:t.departurePort||"",blNumber:t.blNumber||"",palletOrderDate:t.palletOrderDate||"",palletType:t.palletType||"",shippingCompany:t.shippingCompany||"",contractId:t.contractId||"",createdAt:t.createdAt||"",updatedAt:t.updatedAt||""}}mapContract(t,e,a){return{id:t.id,incoterms:t.incoterms||"",contractNumber:t.contractNumber||"",contractDate:t.contractDate||"",exporter:t.exporter||"",importerId:t.importerId||"",departurePort:e.departurePort||"",arrivalPort:e.arrivalPort||"",estimatedTimeDeparture:e.estimatedTimeDeparture||"",estimatedTimeArrival:e.estimatedTimeArrival||"",blNumber:e.blNumber||"",importerName:a?.importerName||"",createdAt:t.createdAt||"",updatedAt:t.updatedAt||""}}mapPayment(t){return{id:t.id,paymentDueDate:t.paymentDueDate||"",paymentMethod:t.paymentMethod||"",contractId:t.contractId,advancePaymentDate:t.advancePaymentDate||"",advancePaymentRatio:t.advancePaymentRatio||0,advancePaymentAmount:this.calculatedValues.advancePaymentAmount,remainingPaymentDate:t.remainingPaymentDate||"",remainingPaymentRatio:t.remainingPaymentRatio||0,remainingPaymentAmount:this.calculatedValues.remainingPaymentAmount,counterpartBank:t.counterpartBank||"",paymentTerm:t.paymentTerm||"",totalContractAmount:this.calculatedValues.totalContractPrice}}mapAndCalculateCostDetail(t){return{id:t.id,unitPrice:t.unitPrice||0,totalContractPrice:this.calculatedValues.totalContractPrice,exchangeRate:t.exchangeRate||0,costPerKg:this.calculatedValues.costPerKg,costId:t.costId,customTaxAmount:this.calculatedValues.customTaxAmount,customsTaxRate:t.customsTaxRate||0,customsFee:t.customsFee||0,inspectionFee:t.inspectionFee||0,doCharge:t.doCharge||0,otherCosts:t.otherCosts||0,transferFee:t.transferFee||0}}mapAndCalculateContractAmount(t,e){return{id:e.id,cargoId:e.cargoId,contractorCost:this.calculatedValues.contractorCost,supplyPrice:this.calculatedValues.supplyPrice,contractorProfit:this.calculatedValues.contractorProfit,shippingCost:e.shippingCost||0,laborCost:e.laborCost||0,transportStorageFee:e.transportStorageFee||0,loadingUnloadingFee:e.loadingUnloadingFee||0,usanceInterest:e.usanceInterest||0}}mapAndCalculateExpense(t){return{id:t.id,itemsId:t.itemsId,shipmentId:t.shipmentId,containerCount:t.containerCount,contractTon:t.contractTon,customsClearanceDate:t.customsClearanceDate,quarantineDate:t.quarantineDate,warehouseEntryDate:t.warehouseEntryDate,progressStatus:t.progressStatus,totalCost:this.calculatedValues.totalCost,totalCostPerKg:this.calculatedValues.totalCostPerKg,sellingPrice:t.sellingPrice||0,sellingPriceWholesale:t.sellingPriceWholesale||0,sellingPriceRetail:t.sellingPriceRetail||0,margin:this.calculatedValues.margin,totalProfit:this.calculatedValues.totalProfit,purchaseFeeRate:t.purchaseFeeRate,remark:t.remark,createdAt:t.createdAt,updatedAt:t.updatedAt}}calculate(){return{importer:this.data.importer,contract:this.mapContract(this.data.contract,this.data.shipment,this.data.importer),payment:this.mapPayment(this.data.payment),costDetail:this.mapAndCalculateCostDetail(this.data.costDetail),cost:this.mapAndCalculateContractAmount(this.data.cargo,this.data.cost),cargo:this.mapAndCalculateExpense(this.data.cargo),item:this.mapItem(this.data.item),shipment:this.mapShipment(this.data.shipment)}}}function l(t){return new c(t).calculate()}},73103:(t,e,a)=>{a.d(e,{LE:()=>r});let r={REVIEW:"검토중",CONTRACTING:"계약중",BEFORE_LC:"L/C오픈전",BEFORE_ARRIVAL:"입항전",WAREHOUSE_MOVING:"창고 이동중",BEFORE_QUARANTINE:"검역전",QUARANTINING:"검역중",CUSTOMS_DECLARING:"세관신고중",DONE_ARRIVAL:"입항완료",AFTER_CUSTOMS:"통관완료",SELLING:"판매중"}}};
