"use strict";exports.id=971,exports.ids=[971],exports.modules={10854:(t,e,a)=>{a.d(e,{A:()=>r});var r=function(t){return t.STANDARD="STANDARD",t.DNB="DNB",t.NAMHAE="NAMHAE",t}({})},18971:(t,e,a)=>{a.d(e,{op:()=>p,qT:()=>m,ws:()=>u});var r=a(17464);a(55414);var o=a(13913),n=a(8613),i=a(26763),s=a(70954),c=a(10854),l=a(73103),d=a(98149);async function m(t,e){try{let a=(0,i.Ak)(),r=(0,i.Ak)();try{await o.db.insert(n.contracts).values({id:a,contractNumber:t.contractNumber,contractDate:t.contractDate,exporter:t.exporter,importerId:t.importer,incoterms:t.incoterms}).returning()}catch(t){throw console.error("계약 정보 저장 중 오류:",t),Error(`계약 정보 저장 실패: ${t instanceof Error?t.message:"알 수 없는 오류"}`)}try{let e=(0,i.Ak)();await o.db.insert(n.payments).values({id:e,paymentDueDate:t.contractDate,paymentMethod:"T/T",contractId:a}).returning(),await o.db.insert(n.paymentsTt).values({paymentId:e,advancePaymentDate:t.contractDate,advancePaymentRatio:30,remainingPaymentDate:t.contractDate,remainingPaymentRatio:70,counterpartBank:""}).returning()}catch(t){throw console.error("결제 정보 저장 중 오류:",t),Error(`결제 정보 저장 실패: ${t instanceof Error?t.message:"알 수 없는 오류"}`)}try{await o.db.insert(n.shipments).values({id:r,contractId:a,estimatedTimeArrival:t.estimatedTimeArrival,estimatedTimeDeparture:t.estimatedTimeDeparture,arrivalPort:t.arrivalPort,departurePort:t.departurePort}).returning()}catch(t){throw console.error("선적 정보 저장 중 오류:",t),Error(`선적 정보 저장 실패: ${t instanceof Error?t.message:"알 수 없는 오류"}`)}for(let a of e)try{let e;let s=(0,i.Ak)(),c=await o.db.query.items.findFirst({where:(t,{eq:e,and:r})=>r(e(t.itemName,a.itemName),a.itemVariety?e(t.itemVariety,a.itemVariety):void 0,a.hsCode?e(t.hsCode,a.hsCode):void 0,e(t.packingUnit,a.packingUnit))});if(c)e=c.id;else{let[t]=await o.db.insert(n.items).values({id:(0,i.Ak)(),itemName:a.itemName,itemVariety:a.itemVariety,originCountry:null,hsCode:a.hsCode,packingUnit:a.packingUnit}).returning();e=t.id}let l=(0,i.Ak)();await o.db.insert(n.cargos).values({id:l,itemsId:e,shipmentId:r,containerCount:Math.ceil(a.contractTon/24),contractTon:a.contractTon,progressStatus:"REVIEW",purchaseFeeRate:a.purchaseFeeRate||await g(t.importer),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}).returning(),await o.db.insert(n.costs).values({id:s,cargoId:l,supplyPrice:a.unitPrice,laborCost:30*a.contractTon*1e3,transportStorageFee:30*a.contractTon*1e3,loadingUnloadingFee:30*a.contractTon*1e3}).returning(),await o.db.insert(n.costDetails).values({id:(0,i.Ak)(),costId:s,unitPrice:a.unitPrice,exchangeRate:a.exchangeRate,customsTaxRate:a.customsTaxRate,customsFee:0,inspectionFee:0,doCharge:0,otherCosts:0,transferFee:0}).returning()}catch(t){throw console.error("화물 정보 저장 중 오류:",t),Error(`화물 정보 저장 실패: ${t instanceof Error?t.message:"알 수 없는 오류"}`)}return{success:!0,message:"계획이 성공적으로 저장되었습니다."}}catch(t){return console.error("계획 저장 중 오류 발생:",t),t instanceof Error&&console.error("오류 상세:",{message:t.message,stack:t.stack,name:t.name}),{success:!1,message:`계획 저장 중 오류가 발생했습니다: ${t instanceof Error?t.message:"알 수 없는 오류"}`}}}async function p(){return(await o.db.query.cargos.findMany({with:{item:!0,shipment:{with:{contract:{with:{importer:!0,payments:{with:{paymentsTt:!0}}}}}},costs:{with:{costDetails:!0}}},orderBy:(t,{desc:e})=>[e(t.createdAt)]})).map(t=>{let e=t.item,a=t.shipment,r=a?.contract,o=r?.importer,n=r?.payments?.[0],i=n?.paymentsTt,d=t.costs?.[0],m=d?.costDetails?.[0],p={contract:{id:r?.id||"",contractNumber:r?.contractNumber||"",contractDate:r?.contractDate||"",exporter:r?.exporter||"",importerId:r?.importerId||"",incoterms:r?.incoterms||"",createdAt:r?.createdAt||"",updatedAt:r?.updatedAt||""},shipment:{id:a?.id||"",contractId:r?.id||"",estimatedTimeDeparture:a?.estimatedTimeDeparture||"",estimatedTimeArrival:a?.estimatedTimeArrival||"",shippingCompany:a?.shippingCompany||"",departurePort:a?.departurePort||"",arrivalPort:a?.arrivalPort||"",blNumber:a?.blNumber||"",palletOrderDate:a?.palletOrderDate||"",palletType:a?.palletType||"",createdAt:a?.createdAt||"",updatedAt:a?.updatedAt||""},cargo:{id:t?.id||"",remark:t?.remark||"",itemsId:t?.itemsId||"",shipmentId:a?.id||"",containerCount:t?.containerCount||0,contractTon:t?.contractTon||0,progressStatus:t?.progressStatus||"예정",customsClearanceDate:t?.customsClearanceDate||"",quarantineDate:t?.quarantineDate||"",warehouseEntryDate:t?.warehouseEntryDate||"",sellingPrice:t?.sellingPrice||0,margin:t?.margin||0,totalProfit:t?.totalProfit||0,purchaseFeeRate:t?.purchaseFeeRate||0,sellingPriceWholesale:t?.sellingPriceWholesale||0,sellingPriceRetail:t?.sellingPriceRetail||0,createdAt:t?.createdAt||"",updatedAt:t?.updatedAt||""},cost:{id:d?.id||"",cargoId:t?.id||"",supplyPrice:d?.supplyPrice||0,shippingCost:d?.shippingCost||0,laborCost:d?.laborCost||0,transportStorageFee:d?.transportStorageFee||0,loadingUnloadingFee:d?.loadingUnloadingFee||0,usanceInterest:d?.usanceInterest||0,gompyoLaborCost:d?.gompyoLaborCost||0,gompyoTransportStorageFee:d?.gompyoTransportStorageFee||0,gompyoLoadingUnloadingFee:d?.gompyoLoadingUnloadingFee||0},costDetail:{id:m?.id||"",costId:d?.id||"",unitPrice:m?.unitPrice||0,exchangeRate:m?.exchangeRate||0,customsTaxRate:m?.customsTaxRate||0,customsFee:m?.customsFee||0,inspectionFee:m?.inspectionFee||0,doCharge:m?.doCharge||0,otherCosts:m?.otherCosts||0,transferFee:m?.transferFee||0},payment:{id:n?.id||"",contractId:r?.id||"",paymentMethod:n?.paymentMethod||"",paymentDueDate:n?.paymentDueDate||"",advancePaymentDate:i?.advancePaymentDate||"",advancePaymentRatio:i?.advancePaymentRatio||0,remainingPaymentDate:i?.remainingPaymentDate||"",remainingPaymentRatio:i?.remainingPaymentRatio||0,counterpartBank:i?.counterpartBank||"",paymentTerm:""},item:{id:e?.id||"",itemName:e?.itemName||"",itemVariety:e?.itemVariety||"",packingUnit:e?.packingUnit||"",originCountry:e?.originCountry||"",hsCode:e?.hsCode||""},importer:{id:o?.id||"",importerName:o?.importerName||"",calculationType:o?.calculationType||c.A.STANDARD}},u=(0,s.s)(p);return{id:t?.id||"",contractNumber:r?.contractNumber||"",progressStatus:l.LE[t?.progressStatus]||"예정",contractDate:r?.contractDate||"",importer:o?.importerName||"",exporter:r?.exporter||"",estimatedTimeArrival:a?.estimatedTimeArrival||"",arrivalPort:a?.arrivalPort||"",itemName:e?.itemName||"",contractTon:t?.contractTon||0,unitPrice:u.costDetail.unitPrice||0,totalPrice:u.costDetail.totalContractPrice||0,paymentMethod:n?.paymentMethod||"",warehouseEntryDate:t?.warehouseEntryDate||"",importCostPerKg:u.costDetail.costPerKg||0,supplyCostPerKg:u.cost.supplyPrice||0,totalCost:u.cargo.totalCost||0,totalCostPerKg:u.cargo.totalCostPerKg||0,sellingPrice:u.cargo.sellingPrice||0,margin:u.cargo.margin||0,totalProfit:u.cargo.totalProfit||0,packingUnit:e?.packingUnit||""}})}async function u(t){try{await o.db.delete(n.cargos).where((0,d.RV)(n.cargos.id,t))}catch(t){throw console.error("Failed to delete plans:",t),Error("계획 삭제 중 오류가 발생했습니다.")}}async function g(t){let e=await o.db.query.importers.findFirst({where:(e,{eq:a})=>a(e.id,t)});return e?.calculationType===c.A.NAMHAE||e?.calculationType===c.A.DNB?6:e?.calculationType===c.A.STANDARD?0:0}(0,a(1634).D)([m,p,u]),(0,r.A)(m,"606d9cda8a7251d423c867e68bd2712076dd3d75b5",null),(0,r.A)(p,"00c98c97faae77e41f0007f4da888035fa98e3bd96",null),(0,r.A)(u,"4014f8936396d6646e3a51928c12b6bfe6f86e45fb",null)},70954:(t,e,a)=>{a.d(e,{s:()=>l});var r=a(10854);class o{calculate(t,e){let a=t.contractorCost*(1+e.purchaseFeeRate/100),r=(a-t.contractorCost)*e.contractTon*1e3,o=a*e.contractTon*1e3+e.shippingCost+e.laborCost+e.transportStorageFee+e.loadingUnloadingFee+e.gompyoLaborCost+e.gompyoTransportStorageFee+e.gompyoLoadingUnloadingFee,n=e.sellingPrice-o/e.contractTon/1e3,i=n*e.contractTon*1e3,s=o/e.contractTon/1e3;return{supplyPrice:a,contractorProfit:r,totalCost:o,margin:n,totalProfit:i,totalCostPerKg:s}}}class n{calculate(t,e){let a=(t.contractorCostAmount+e.shippingCost+e.laborCost+e.transportStorageFee+e.loadingUnloadingFee+e.usanceInterest)/e.contractTon/1e3*(1+e.purchaseFeeRate/100),r=(a-t.contractorCost)*e.contractTon*1e3,o=a*e.contractTon*1e3+e.gompyoLaborCost+e.gompyoLoadingUnloadingFee+e.gompyoTransportStorageFee,n=e.sellingPrice-o/e.contractTon/1e3,i=n*e.contractTon*1e3,s=o/e.contractTon/1e3;return{supplyPrice:a,contractorProfit:r,totalCost:o,margin:n,totalProfit:i,totalCostPerKg:s}}}class i{calculate(t,e){let a=t.contractorCost*(1+e.purchaseFeeRate/100),r=(a-t.contractorCost)*e.contractTon*1e3,o=a*e.contractTon*1e3+e.shippingCost+e.laborCost+e.transportStorageFee+e.loadingUnloadingFee+e.gompyoLaborCost+e.gompyoTransportStorageFee+e.gompyoLoadingUnloadingFee,n=e.sellingPrice-o/e.contractTon/1e3,i=n*e.contractTon*1e3,s=o/e.contractTon/1e3;return{supplyPrice:a,contractorProfit:r,totalCost:o,margin:n,totalProfit:i,totalCostPerKg:s}}}class s{static createStrategy(t){if(!t)return new o;switch(t.calculationType){case r.A.STANDARD:return new o;case r.A.DNB:return new n;case r.A.NAMHAE:return new i;default:return new o}}}class c{constructor(t){this.data=t,this.calculationStrategy=s.createStrategy(t.importer),this.calculatedValues=this.calculateValues()}calculateValues(){let t=this.data.costDetail.unitPrice||0,e=this.data.costDetail.exchangeRate||0,a=this.data.cargo.contractTon||0,r=this.data.cargo.sellingPrice||0,o=this.data.cargo.purchaseFeeRate||0,n=Math.floor(t*e*a),i=t*e/1e3,s=n*(this.data.costDetail.customsTaxRate||0)/100,c=n+s+(this.data.costDetail.transferFee||0)+(this.data.costDetail.customsFee||0)+(this.data.costDetail.inspectionFee||0)+(this.data.costDetail.doCharge||0)+(this.data.costDetail.otherCosts||0),l=c/a/1e3,d=n*(this.data.payment.advancePaymentRatio||0)/100,m=n*(this.data.payment.remainingPaymentRatio||0)/100,p=this.calculationStrategy.calculate({contractorCostAmount:c,costPerKg:i,totalContractPrice:n,contractorCost:l},{contractTon:a,sellingPrice:r,purchaseFeeRate:o,shippingCost:this.data.cost.shippingCost||0,laborCost:this.data.cost.laborCost||0,transportStorageFee:this.data.cost.transportStorageFee||0,loadingUnloadingFee:this.data.cost.loadingUnloadingFee||0,usanceInterest:this.data.cost.usanceInterest||0,gompyoLaborCost:this.data.cost.gompyoLaborCost||0,gompyoTransportStorageFee:this.data.cost.gompyoTransportStorageFee||0,gompyoLoadingUnloadingFee:this.data.cost.gompyoLoadingUnloadingFee||0});return{supplyPrice:p.supplyPrice,margin:p.margin,totalProfit:p.totalProfit,totalContractPrice:n,costPerKg:i,contractorCost:l,contractorProfit:p.contractorProfit,totalCost:p.totalCost,totalCostPerKg:p.totalCostPerKg,customTaxAmount:s,advancePaymentAmount:d,remainingPaymentAmount:m}}mapItem(t){return{id:t.id,itemName:t.itemName||"",itemVariety:t.itemVariety||"",originCountry:t.originCountry||"",hsCode:t.hsCode||"",packingUnit:t.packingUnit||""}}mapShipment(t){return{id:t.id,estimatedTimeArrival:t.estimatedTimeArrival||"",estimatedTimeDeparture:t.estimatedTimeDeparture||"",arrivalPort:t.arrivalPort||"",departurePort:t.departurePort||"",blNumber:t.blNumber||"",palletOrderDate:t.palletOrderDate||"",palletType:t.palletType||"",shippingCompany:t.shippingCompany||"",contractId:t.contractId||"",createdAt:t.createdAt||"",updatedAt:t.updatedAt||""}}mapContract(t,e,a){return{id:t.id,incoterms:t.incoterms||"",contractNumber:t.contractNumber||"",contractDate:t.contractDate||"",exporter:t.exporter||"",importerId:t.importerId||"",departurePort:e.departurePort||"",arrivalPort:e.arrivalPort||"",estimatedTimeDeparture:e.estimatedTimeDeparture||"",estimatedTimeArrival:e.estimatedTimeArrival||"",blNumber:e.blNumber||"",importerName:a?.importerName||"",createdAt:t.createdAt||"",updatedAt:t.updatedAt||""}}mapPayment(t){return{id:t.id,paymentDueDate:t.paymentDueDate||"",paymentMethod:t.paymentMethod||"",contractId:t.contractId,advancePaymentDate:t.advancePaymentDate||"",advancePaymentRatio:t.advancePaymentRatio||0,advancePaymentAmount:this.calculatedValues.advancePaymentAmount,remainingPaymentDate:t.remainingPaymentDate||"",remainingPaymentRatio:t.remainingPaymentRatio||0,remainingPaymentAmount:this.calculatedValues.remainingPaymentAmount,counterpartBank:t.counterpartBank||"",paymentTerm:t.paymentTerm||"",totalContractAmount:this.calculatedValues.totalContractPrice}}mapAndCalculateCostDetail(t){return{id:t.id,unitPrice:t.unitPrice||0,totalContractPrice:this.calculatedValues.totalContractPrice,exchangeRate:t.exchangeRate||0,costPerKg:this.calculatedValues.costPerKg,costId:t.costId,customTaxAmount:this.calculatedValues.customTaxAmount,customsTaxRate:t.customsTaxRate||0,customsFee:t.customsFee||0,inspectionFee:t.inspectionFee||0,doCharge:t.doCharge||0,otherCosts:t.otherCosts||0,transferFee:t.transferFee||0}}mapAndCalculateContractAmount(t,e){return{id:e.id,cargoId:e.cargoId,contractorCost:this.calculatedValues.contractorCost,supplyPrice:this.calculatedValues.supplyPrice,contractorProfit:this.calculatedValues.contractorProfit,shippingCost:e.shippingCost||0,laborCost:e.laborCost||0,transportStorageFee:e.transportStorageFee||0,loadingUnloadingFee:e.loadingUnloadingFee||0,usanceInterest:e.usanceInterest||0,gompyoLaborCost:e.gompyoLaborCost||0,gompyoTransportStorageFee:e.gompyoTransportStorageFee||0,gompyoLoadingUnloadingFee:e.gompyoLoadingUnloadingFee||0}}mapAndCalculateExpense(t){return{id:t.id,itemsId:t.itemsId,shipmentId:t.shipmentId,containerCount:t.containerCount,contractTon:t.contractTon,customsClearanceDate:t.customsClearanceDate,quarantineDate:t.quarantineDate,warehouseEntryDate:t.warehouseEntryDate,progressStatus:t.progressStatus,totalCost:this.calculatedValues.totalCost,totalCostPerKg:this.calculatedValues.totalCostPerKg,sellingPrice:t.sellingPrice||0,sellingPriceWholesale:t.sellingPriceWholesale||0,sellingPriceRetail:t.sellingPriceRetail||0,margin:this.calculatedValues.margin,totalProfit:this.calculatedValues.totalProfit,purchaseFeeRate:t.purchaseFeeRate,remark:t.remark,createdAt:t.createdAt,updatedAt:t.updatedAt}}calculate(){return{importer:this.data.importer,contract:this.mapContract(this.data.contract,this.data.shipment,this.data.importer),payment:this.mapPayment(this.data.payment),costDetail:this.mapAndCalculateCostDetail(this.data.costDetail),cost:this.mapAndCalculateContractAmount(this.data.cargo,this.data.cost),cargo:this.mapAndCalculateExpense(this.data.cargo),item:this.mapItem(this.data.item),shipment:this.mapShipment(this.data.shipment)}}}function l(t){return new c(t).calculate()}},73103:(t,e,a)=>{a.d(e,{LE:()=>r});let r={REVIEW:"검토중",CONTRACTING:"계약중",BEFORE_LC:"L/C오픈전",BEFORE_ARRIVAL:"입항전",WAREHOUSE_MOVING:"창고 이동중",BEFORE_QUARANTINE:"검역전",QUARANTINING:"검역중",CUSTOMS_DECLARING:"세관신고중",DONE_ARRIVAL:"입항완료",AFTER_CUSTOMS:"통관완료",SELLING:"판매중"}}};
