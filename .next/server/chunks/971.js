"use strict";exports.id=971,exports.ids=[971],exports.modules={18971:(t,e,a)=>{a.d(e,{op:()=>T,qT:()=>D,ws:()=>A});var r=a(17464);a(55414);var n=a(13913),o=a(8613),i=a(26763),s=a(70954),c=a(70564),l=a(37988),m=a(22168),d=a(26647),u=a(5485),p=a(22327),g=a(54022),h=a(21316),P=a(10854),y=a(73103),C=a(98149);async function D(t,e){try{console.log("계약 정보 저장 시작:",t),console.log("화물 정보 저장 시작:",e);let a=(0,i.Ak)(),r=(0,i.Ak)();try{let[e]=await n.db.insert(o.contracts).values({id:a,contractNumber:t.contractNumber,contractDate:t.contractDate,exporter:t.exporter,importerId:t.importer,incoterms:t.incoterms}).returning();console.log("계약 정보 저장 완료:",e)}catch(t){throw console.error("계약 정보 저장 중 오류:",t),Error(`계약 정보 저장 실패: ${t instanceof Error?t.message:"알 수 없는 오류"}`)}try{let e=(0,i.Ak)(),[r]=await n.db.insert(o.payments).values({id:e,paymentDueDate:t.contractDate,paymentMethod:"T/T",contractId:a}).returning();console.log("결제 정보 저장 완료:",r);let[s]=await n.db.insert(o.paymentsTt).values({paymentId:e,advancePaymentDate:t.contractDate,advancePaymentRatio:30,advancePaymentAmount:0,remainingPaymentDate:t.contractDate,remainingPaymentRatio:70,remainingPaymentAmount:0,counterpartBank:""}).returning();console.log("T/T 결제 상세 정보 저장 완료:",s)}catch(t){throw console.error("결제 정보 저장 중 오류:",t),Error(`결제 정보 저장 실패: ${t instanceof Error?t.message:"알 수 없는 오류"}`)}try{let[e]=await n.db.insert(o.shipments).values({id:r,contractId:a,estimatedTimeArrival:t.estimatedTimeArrival,estimatedTimeDeparture:t.estimatedTimeDeparture,arrivalPort:t.arrivalPort,departurePort:t.departurePort}).returning();console.log("선적 정보 저장 완료:",e)}catch(t){throw console.error("선적 정보 저장 중 오류:",t),Error(`선적 정보 저장 실패: ${t instanceof Error?t.message:"알 수 없는 오류"}`)}for(let t of e)try{let e;let a=(0,i.Ak)(),s=await n.db.query.items.findFirst({where:(e,{eq:a,and:r})=>r(a(e.itemName,t.itemName),a(e.itemVariety,t.itemVariety),t.hsCode?a(e.hsCode,t.hsCode):void 0,a(e.packingUnit,t.packingUnit))});if(s)e=s.id;else{let[a]=await n.db.insert(o.items).values({id:(0,i.Ak)(),itemName:t.itemName,itemVariety:t.itemVariety,originCountry:null,hsCode:t.hsCode,packingUnit:t.packingUnit}).returning();e=a.id,console.log("새로운 품목 정보 저장 완료:",a)}let c=(0,i.Ak)(),l=t.unitPrice*t.exchangeRate*t.contractTon/1e3,[m]=await n.db.insert(o.cargos).values({id:c,itemsId:e,shipmentId:r,containerCount:1,contractTon:t.contractTon,progressStatus:"REVIEW",sellingPrice:t.sellingPrice,margin:t.sellingPrice-l,totalProfit:(t.sellingPrice-l)*t.contractTon*1e3,purchaseFeeRate:0}).returning();console.log("화물 정보 저장 완료:",m);let[d]=await n.db.insert(o.costs).values({id:a,cargoId:c,supplyPrice:t.unitPrice,laborCost:0,transportStorageFee:0,loadingUnloadingFee:0}).returning();console.log("비용 정보 저장 완료:",d);let[u]=await n.db.insert(o.costDetails).values({id:(0,i.Ak)(),costId:a,unitPrice:t.unitPrice,exchangeRate:t.exchangeRate,customsTaxRate:t.customsTaxRate,customTaxAmount:t.customTaxAmount,customsFee:t.customsFee,inspectionFee:t.inspectionFee,doCharge:0,otherCosts:t.otherCosts}).returning();console.log("비용 상세 정보 저장 완료:",u)}catch(t){throw console.error("화물 정보 저장 중 오류:",t),Error(`화물 정보 저장 실패: ${t instanceof Error?t.message:"알 수 없는 오류"}`)}return{success:!0,message:"계획이 성공적으로 저장되었습니다."}}catch(t){return console.error("계획 저장 중 오류 발생:",t),t instanceof Error&&console.error("오류 상세:",{message:t.message,stack:t.stack,name:t.name}),{success:!1,message:`계획 저장 중 오류가 발생했습니다: ${t instanceof Error?t.message:"알 수 없는 오류"}`}}}async function T(){try{let t=new c.y,e=new l.o,a=new m.q,r=new d.b,n=new u.T,o=new p.G,i=new g.W,C=new h.Y,[D,T,A,f,b,w,F,I]=await Promise.all([t.findAll(),e.findAll(),a.findAll(),r.findAll(),n.findAll(),o.findAll(),i.findAll(),C.getAllImporters()]);return A.map(t=>{let e=T.find(e=>e.id===t.shipmentId),a=D.find(t=>t.id===e?.contractId),r=f.find(e=>e.id===t?.itemsId),n=b.find(e=>e.cargoId===t?.id),o=w.find(t=>t.costId===n?.id),i=F.find(t=>t.contractId===a?.id),c=I.find(t=>t.id===a?.importerId),l={contract:{id:a?.id||"",contractNumber:a?.contractNumber||"",contractDate:a?.contractDate||"",exporter:a?.exporter||"",importerId:a?.importerId||"",incoterms:a?.incoterms||""},shipment:{id:e?.id||"",contractId:a?.id||"",estimatedTimeDeparture:e?.estimatedTimeDeparture||"",estimatedTimeArrival:e?.estimatedTimeArrival||"",shippingCompany:e?.shippingCompany||"",departurePort:e?.departurePort||"",arrivalPort:e?.arrivalPort||"",blNumber:e?.blNumber||"",palletOrderDate:e?.palletOrderDate||"",palletType:e?.palletType||""},cargo:{id:t?.id||"",remark:t?.remark||"",itemsId:t?.itemsId||"",shipmentId:e?.id||"",containerCount:t?.containerCount||0,contractTon:t?.contractTon||0,progressStatus:t?.progressStatus||"예정",customsClearanceDate:t?.customsClearanceDate||"",quarantineDate:t?.quarantineDate||"",warehouseEntryDate:t?.warehouseEntryDate||"",sellingPrice:t?.sellingPrice||0,margin:t?.margin||0,totalProfit:t?.totalProfit||0,purchaseFeeRate:t?.purchaseFeeRate||0,sellingPriceWholesale:t?.sellingPriceWholesale||0,sellingPriceRetail:t?.sellingPriceRetail||0},cost:{id:n?.id||"",cargoId:t?.id||"",supplyPrice:n?.supplyPrice||0,shippingCost:n?.shippingCost||0,laborCost:n?.laborCost||0,transportStorageFee:n?.transportStorageFee||0,loadingUnloadingFee:n?.loadingUnloadingFee||0,usanceInterest:n?.usanceInterest||0},costDetail:{id:o?.id||"",costId:n?.id||"",unitPrice:o?.unitPrice||0,exchangeRate:o?.exchangeRate||0,customsTaxRate:o?.customsTaxRate||0,customTaxAmount:o?.customTaxAmount||0,customsFee:o?.customsFee||0,inspectionFee:o?.inspectionFee||0,doCharge:o?.doCharge||0,otherCosts:o?.otherCosts||0,transferFee:o?.transferFee||0},payment:{id:i?.id||"",contractId:a?.id||"",paymentMethod:i?.paymentMethod||"",paymentDueDate:i?.paymentDueDate||"",advancePaymentDate:i?.advancePaymentDate||"",advancePaymentRatio:i?.advancePaymentRatio||0,advancePaymentAmount:i?.advancePaymentAmount||0,remainingPaymentDate:i?.remainingPaymentDate||"",remainingPaymentRatio:i?.remainingPaymentRatio||0,remainingPaymentAmount:i?.remainingPaymentAmount||0,counterpartBank:i?.counterpartBank||"",paymentTerm:i?.paymentTerm||"",totalContractAmount:i?.totalContractAmount||0},item:{id:r?.id||"",itemName:r?.itemName||"",itemVariety:r?.itemVariety||"",packingUnit:r?.packingUnit||"",originCountry:r?.originCountry||"",hsCode:r?.hsCode||""},importer:{id:c?.id||"",importerName:c?.importerName||"",calculationType:c?.calculationType||P.A.STANDARD}},m=(0,s.s)(l);return{id:t?.id||"",contractNumber:a?.contractNumber||"",progressStatus:y.LE[t?.progressStatus]||"예정",contractDate:a?.contractDate||"",importer:c?.importerName||"",exporter:a?.exporter||"",estimatedTimeArrival:e?.estimatedTimeArrival||"",arrivalPort:e?.arrivalPort||"",itemName:r?.itemName||"",contractTon:t?.contractTon||0,unitPrice:m.costDetail.unitPrice||0,totalPrice:m.costDetail.totalContractPrice||0,paymentMethod:i?.paymentMethod||"",warehouseEntryDate:t?.warehouseEntryDate||"",importCostPerKg:m.costDetail.costPerKg||0,supplyCostPerKg:m.cost.supplyPrice||0,totalCost:m.cost.contractorCost||0,totalCostPerKg:m.costDetail.costPerKg||0,sellingPrice:m.cargo.sellingPrice||0,margin:m.cargo.margin||0,totalProfit:m.cargo.totalProfit||0}})}catch(t){throw console.error("Failed to fetch plan data:",t),Error("계획 데이터를 불러오는데 실패했습니다.")}}async function A(t){try{await n.db.delete(o.cargos).where((0,C.RV)(o.cargos.id,t))}catch(t){throw console.error("Failed to delete plans:",t),Error("계획 삭제 중 오류가 발생했습니다.")}}(0,a(1634).D)([D,T,A]),(0,r.A)(D,"604a62e1ca84202863f826d3c4deffdbf3fe7adab0",null),(0,r.A)(T,"00226fc192fdba35a8d3d9ec124800bd9bf5aad923",null),(0,r.A)(A,"403234cdbf1eb746e276e5e1a4235188c0aa3859b2",null)},26647:(t,e,a)=>{a.d(e,{b:()=>s});var r=a(13913),n=a(8613),o=a(98149),i=a(26763);class s{async create(t){let e=(0,i.Ak)(),[a]=await r.db.insert(n.items).values({...t,id:e}).returning();return a}async findById(t){let[e]=await r.db.select().from(n.items).where((0,o.eq)(n.items.id,t));return e}async searchItems(t){return await r.db.select().from(n.items).where((0,o.eq)(n.items.itemName,t))}async findAll(){return await r.db.select().from(n.items)}async update(t,e){let[a]=await r.db.update(n.items).set(e).where((0,o.eq)(n.items.id,t)).returning();return a}async delete(t){let[e]=await r.db.delete(n.items).where((0,o.eq)(n.items.id,t)).returning();return e}}},70954:(t,e,a)=>{a.d(e,{s:()=>l});var r=a(10854);class n{calculate(t,e){let a=t.contractorCost*(1+e.purchaseFeeRate/100),r=(a-t.contractorCost)*e.contractTon*1e3,n=a*e.contractTon*1e3+e.shippingCost+e.laborCost+e.transportStorageFee+e.loadingUnloadingFee,o=e.sellingPrice-n/e.contractTon/1e3,i=o*e.contractTon*1e3;return{supplyPrice:a,contractorProfit:r,totalCost:n,margin:o,totalProfit:i}}}class o{calculate(t,e){let a=(t.contractorCostAmount+e.shippingCost+e.laborCost+e.transportStorageFee+e.loadingUnloadingFee+e.usanceInterest)/e.contractTon/1e3*(1+e.purchaseFeeRate/100),r=(a-t.contractorCost)*e.contractTon*1e3,n=a*e.contractTon*1e3,o=e.sellingPrice-n/e.contractTon/1e3,i=o*e.contractTon*1e3;return{supplyPrice:a,contractorProfit:r,totalCost:n,margin:o,totalProfit:i}}}class i{calculate(t,e){let a=t.contractorCost*(1+e.purchaseFeeRate/100),r=(a-t.contractorCost)*e.contractTon*1e3,n=a*e.contractTon*1e3+e.shippingCost+e.laborCost+e.transportStorageFee+e.loadingUnloadingFee,o=e.sellingPrice-n/e.contractTon/1e3,i=o*e.contractTon*1e3;return{supplyPrice:a,contractorProfit:r,totalCost:n,margin:o,totalProfit:i}}}class s{static createStrategy(t){if(!t)return new n;switch(t.calculationType){case r.A.STANDARD:return new n;case r.A.DNB:return new o;case r.A.NAMHAE:return new i;default:return new n}}}class c{constructor(t){this.data=t,this.calculationStrategy=s.createStrategy(t.importer),this.calculatedValues=this.calculateValues()}calculateValues(){let t=this.data.costDetail.unitPrice||0,e=this.data.costDetail.exchangeRate||0,a=this.data.cargo.contractTon||0,r=this.data.cargo.sellingPrice||0,n=this.data.cargo.purchaseFeeRate||0,o=Math.floor(t*e*a),i=t*e/1e3,s=o+(this.data.costDetail.customTaxAmount||0)+(this.data.costDetail.transferFee||0)+(this.data.costDetail.customsFee||0)+(this.data.costDetail.inspectionFee||0)+(this.data.costDetail.doCharge||0)+(this.data.costDetail.otherCosts||0),c=s/a/1e3,l=this.calculationStrategy.calculate({contractorCostAmount:s,costPerKg:i,totalContractPrice:o,contractorCost:c},{contractTon:a,sellingPrice:r,purchaseFeeRate:n,shippingCost:this.data.cost.shippingCost||0,laborCost:this.data.cost.laborCost||0,transportStorageFee:this.data.cost.transportStorageFee||0,loadingUnloadingFee:this.data.cost.loadingUnloadingFee||0,usanceInterest:this.data.cost.usanceInterest||0});return{supplyPrice:l.supplyPrice,margin:l.margin,totalProfit:l.totalProfit,totalContractPrice:o,costPerKg:i,contractorCost:c,contractorProfit:l.contractorProfit,totalCost:l.totalCost}}mapItem(t){return{id:t.id,itemName:t.itemName||"",itemVariety:t.itemVariety||"",originCountry:t.originCountry||"",hsCode:t.hsCode||"",packingUnit:t.packingUnit||""}}mapShipment(t){return{id:t.id,estimatedTimeArrival:t.estimatedTimeArrival||"",estimatedTimeDeparture:t.estimatedTimeDeparture||"",arrivalPort:t.arrivalPort||"",departurePort:t.departurePort||"",blNumber:t.blNumber||"",palletOrderDate:t.palletOrderDate||"",palletType:t.palletType||"",shippingCompany:t.shippingCompany||"",contractId:t.contractId||""}}mapContract(t,e,a){return{id:t.id,incoterms:t.incoterms||"",contractNumber:t.contractNumber||"",contractDate:t.contractDate||"",exporter:t.exporter||"",importerId:t.importerId||"",departurePort:e.departurePort||"",arrivalPort:e.arrivalPort||"",estimatedTimeDeparture:e.estimatedTimeDeparture||"",estimatedTimeArrival:e.estimatedTimeArrival||"",blNumber:e.blNumber||"",importerName:a?.importerName||""}}mapPayment(t){return{id:t.id,paymentDueDate:t.paymentDueDate||"",paymentMethod:t.paymentMethod||"",contractId:t.contractId,advancePaymentDate:t.advancePaymentDate||"",advancePaymentRatio:t.advancePaymentRatio||0,advancePaymentAmount:t.advancePaymentAmount||0,remainingPaymentDate:t.remainingPaymentDate||"",remainingPaymentRatio:t.remainingPaymentRatio||0,remainingPaymentAmount:t.remainingPaymentAmount||0,counterpartBank:t.counterpartBank||"",paymentTerm:t.paymentTerm||"",totalContractAmount:this.calculatedValues.totalContractPrice}}mapAndCalculateCostDetail(t){return{id:t.id,unitPrice:t.unitPrice||0,totalContractPrice:this.calculatedValues.totalContractPrice,exchangeRate:t.exchangeRate||0,costPerKg:this.calculatedValues.costPerKg,costId:t.costId,customTaxAmount:t.customTaxAmount||0,customsTaxRate:t.customsTaxRate||0,customsFee:t.customsFee||0,inspectionFee:t.inspectionFee||0,doCharge:t.doCharge||0,otherCosts:t.otherCosts||0,transferFee:t.transferFee||0}}mapAndCalculateContractAmount(t,e){return{id:e.id,cargoId:e.cargoId,contractorCost:this.calculatedValues.contractorCost,supplyPrice:this.calculatedValues.supplyPrice,contractorProfit:this.calculatedValues.contractorProfit,shippingCost:e.shippingCost||0,laborCost:e.laborCost||0,transportStorageFee:e.transportStorageFee||0,loadingUnloadingFee:e.loadingUnloadingFee||0,usanceInterest:e.usanceInterest||0}}mapAndCalculateExpense(t){return{id:t.id,itemsId:t.itemsId,shipmentId:t.shipmentId,containerCount:t.containerCount,contractTon:t.contractTon,customsClearanceDate:t.customsClearanceDate,quarantineDate:t.quarantineDate,warehouseEntryDate:t.warehouseEntryDate,progressStatus:t.progressStatus,totalCost:this.calculatedValues.totalCost,sellingPrice:t.sellingPrice||0,sellingPriceWholesale:t.sellingPriceWholesale||0,sellingPriceRetail:t.sellingPriceRetail||0,margin:this.calculatedValues.margin,totalProfit:this.calculatedValues.totalProfit,purchaseFeeRate:t.purchaseFeeRate,remark:t.remark}}calculate(){return{importer:this.data.importer,contract:this.mapContract(this.data.contract,this.data.shipment,this.data.importer),payment:this.mapPayment(this.data.payment),costDetail:this.mapAndCalculateCostDetail(this.data.costDetail),cost:this.mapAndCalculateContractAmount(this.data.cargo,this.data.cost),cargo:this.mapAndCalculateExpense(this.data.cargo),item:this.mapItem(this.data.item),shipment:this.mapShipment(this.data.shipment)}}}function l(t){return new c(t).calculate()}}};
